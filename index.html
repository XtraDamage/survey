<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ОПРОС</title>
    <!-- Подключаем пиксельный шрифт 'Press Start 2P' с Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Подключаем Tone.js для звуковых эффектов -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive; /* Применяем пиксельный шрифт */
            background-color: #000; /* Чисто черный фон */
            color: #fff; /* Белый текст по умолчанию */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            flex-direction: column; /* Для выравнивания по центру */
        }

        .container {
            background-color: transparent; /* Прозрачный фон контейнера */
            padding: 40px 30px;
            border-radius: 5px; /* Немного скругленные углы */
            border: 2px solid #333; /* Тонкая рамка */
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: none; /* Убираем тень */
            transition: transform 0.5s ease-out; /* Плавное изменение размера */
            position: relative; /* Для позиционирования */
        }

        h1 {
            color: #fff; /* Белый цвет для заголовка */
            margin-bottom: 30px;
            font-size: 1.8em;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }

        p {
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 25px;
            color: #ccc;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 40px;
            color: #fff;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.8s ease-in-out, color 0.8s ease-in-out;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.3);
            white-space: pre-wrap; /* Сохраняет пробелы и переносы строки */
        }

        .options {
            display: flex;
            flex-wrap: wrap; /* Чтобы кнопки переносились на новую строку, если не помещаются */
            justify-content: center;
            gap: 15px; /* Промежуток между кнопками */
            min-height: 60px; /* Чтобы не скакало при появлении */
        }

        .options button {
            background-color: transparent;
            color: #fff;
            border: 2px solid #fff;
            padding: 15px 25px;
            margin: 0; /* Убрал margin, использую gap */
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            /* Анимируем opacity и transform */
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, transform 0.5s ease-out, opacity 0.5s ease-out;
            min-width: 140px;
            box-shadow: none;
            letter-spacing: 1px;
            /* Изначально скрыты по прозрачности и видимости, без трансформации */
            opacity: 0; 
            visibility: hidden; 
            position: relative; /* Для анимации translateX/Y */
        }

        /* Стиль для кнопки "НАЧАТЬ", чтобы она была сразу видна */
        .options .start-button {
            opacity: 1;
            visibility: visible;
            transform: translateX(0); /* Убедимся, что она на месте */
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, transform 0.2s; /* Упрощенный transition */
        }

        .options button:hover {
            background-color: #fff;
            color: #000;
            border-color: #fff;
            transform: scale(1.02);
        }

        .options button:active {
            transform: scale(0.98);
        }

        /* Новые классы для начальных трансформаций кнопок */
        .options button.initial-transform-da {
            transform: translateX(-100%);
        }
        .options button.initial-transform-net {
            transform: translateX(100%);
        }
        .options button.initial-transform-neznao {
            transform: translateY(100%);
        }

        /* Класс, который делает кнопки видимыми и запускает анимацию */
        .options button.show-button {
            opacity: 1;
            visibility: visible; /* Делаем видимым */
            transform: none; /* Перемещаем в конечную позицию (центр) */
        }

        .end-screen {
            display: none;
            font-size: 1.2em;
            color: #ff0000;
            text-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
            animation: flicker 0.5s infinite alternate;
        }

        @keyframes flicker {
            from { opacity: 1; text-shadow: 0 0 15px rgba(255, 0, 0, 0.7); }
            to { opacity: 0.8; text-shadow: 0 0 5px rgba(255, 0, 0, 0.3); }
        }

        /* Стадии для нарастающего напряжения - меняется цвет текста вопросов и легкий оттенок */
        .stage-1 .question-text { color: #fff; }
        .stage-2 .question-text { color: #f0f0f0; }
        .stage-3 .question-text { color: #e0e0e0; }
        .stage-4 .question-text { color: #d0d0d0; }
        .stage-final .question-text { color: #c0c0c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ОПРОС</h1>
        <p>Ваша готовность отвечать будет оценена.</p>

        <div class="game-area">
            <div class="question-text" id="question">Начать опрос?</div>
            <div class="options" id="options">
                <!-- Кнопка "НАЧАТЬ" будет вставлена здесь JS -->
            </div>
        </div>

        <div class="end-screen" id="endScreen">
            <div id="endMessage"></div>
            <p style="margin-top: 30px; font-size: 0.8em; color: #aaa;">СПАСИБО ЗА УЧАСТИЕ.</p>
        </div>
    </div>

    <script>
        // Инициализация Tone.js для звуков печати
        const synth = new Tone.Synth({
            oscillator: { type: "triangle" },
            envelope: {
                attack: 0.001,
                decay: 0.01, /* Очень короткий decay */
                sustain: 0.001, /* Очень короткий sustain */
                release: 0.01 /* Очень короткий release */
            }
        }).toDestination();

        // Функция для симуляции печати текста
        async function typeText(element, text, charDelay = 50) {
            element.innerText = ''; // Очищаем текст перед набором
            let i = 0;
            return new Promise(resolve => {
                const interval = setInterval(() => {
                    if (i < text.length) {
                        element.innerText += text.charAt(i);
                        // Проигрываем звук только для букв и цифр
                        if (text.charAt(i).match(/[а-яА-Яa-zA-Z0-9]/)) {
                            // Воспроизводим звук без смещения, полагаясь на очень короткий release
                            synth.triggerAttackRelease("C4", "64n"); // Очень короткая нота
                        }
                        i++;
                    } else {
                        clearInterval(interval);
                        resolve();
                    }
                }, charDelay);
            });
        }

        // Вопросы и варианты ответов с привязанными "очками тревожности"
        const questions = [
            { // Q1: Normal, very low stakes
                question: "ваш день прошёл хорошо сегодня?",
                scores: { "ДА": 0, "НЕТ": 1, "НЕ ЗНАЮ": 0 }
            },
            { // Q2: Still normal, slightly philosophical
                question: "вы выспались?",
                scores: { "ДА": 0, "НЕТ": 1, "НЕ ЗНАЮ": 1 }
            },
            { // Q3: Slight unease, mundane oddities
                question: "вы бодры?",
                scores: { "ДА": 0, "НЕТ": 1, "НЕ ЗНАЮ": 2 }
            },
            { // Q4: Personal, existential hint
                question: "у вас когда нибудь было дежавю?",
                scores: { "ДА": 2, "НЕТ": 0, "НЕ ЗНАЮ": 1 }
            },
            { // Q5: Reality distortion hint, getting slightly more direct
                question: "вы уверены что вопринимаете мир какой он есть и без искажений?",
                scores: { "ДА": 0, "НЕТ": 3, "НЕ ЗНАЮ": 2 }
            },
            { // Q6: Questioning time, psychological "lie" detection
                question: `ВЫ УВЕРЕНЫ, ЧТО СЕЙЧАС ${new Date().getHours() >= 6 && new Date().getHours() < 20 ? 'ДЕНЬ' : 'НОЧЬ'}?`,
                scores: { "ДА": 0, "НЕТ": 4, "НЕ ЗНАЮ": 3 } 
            },
            { // Q7: Memory, location ambiguity, first truly unsettling question
                question: "ВЫ ПОМНИТЕ, КАК ИМЕННО ОКАЗАЛИСЬ ЗДЕСЬ?",
                scores: { "ДА": 0, "НЕТ": 5, "НЕ ЗНАЮ": 4 }
            },
            { // Q8: Short-term memory distortion, more immediate
                question: "ваши воспоминания за последний час чёткие?",
                scores: { "ДА": 0, "НЕТ": 6, "НЕ ЗНАЮ": 5 }
            },
            { // Q9: Presence, paranoia, direct question about unseen entities
                question: "вы чувствуете кого то в комнате помимо вас?",
                scores: { "ДА": 7, "НЕТ": 0, "НЕ ЗНАЮ": 6 }
            },
            { // Q10: Auditory, first hint of voices, subtle
                question: "слышите ли вы голоса / музыку в голове?",
                scores: { "ДА": 8, "НЕТ": 0, "НЕ ЗНАЮ": 7 }
            },
            { // Q11: Identity crisis, self-alienation, very disturbing
                question: "если вы улыбнётесь в зеркало, оно повторит ваши действия как ожидалось?",
                scores: { "ДА": 0, "НЕТ": 9, "НЕ ЗНАЮ": 8 }
            },
            { // Q12: Loss of bodily autonomy, direct threat to self
                question: "вы когда нибудь теряли контроль над собой?",
                scores: { "ДА": 10, "НЕТ": 0, "НЕ ЗНАЮ": 9 }
            },
            { // Q13: Stronger location questioning, trapped feeling
                question: "вы знаете где вы находитесь НА САМОМ ДЕЛЕ?",
                scores: { "ДА": 0, "НЕТ": 11, "НЕ ЗНАЮ": 10 }
            },
            { // Q14: Escalation of voices, direct and personal
                question: "вы уверены что вы настоящий человек?",
                scores: { "ДА": 12, "НЕТ": 0, "НЕ ЗНАЮ": 11 }
            },
            { // Q15: Final choice, meta-narrative, ultimate despair
                question: "вы уверены?",
                scores: { "ДА": 0, "НЕТ": 0, "НЕ ЗНАЮ": 0 }
            },
            { // Q16: Sense of unreality, subtle
                question: "иногда вам кажется что происходящее нереально?",
                scores: { "ДА": 5, "НЕТ": 0, "НЕ ЗНАЮ": 3 }
            },
            { // Q17: Personal space invasion, psychological
                question: "ваши мысли полностью контролируете вы?",
                scores: { "ДА": 0, "НЕТ": 8, "НЕ ЗНАЮ": 6 }
            },
            { // Q18: Memory manipulation
                question: "...?",
                scores: { "...": 0, "...": 0, "...": 0 }
            },
            { // Q19: Visual distortion
                question: "ЗАМЕЧАЛИ ЛИ ВЫ, ЧТО ПРЕДМЕТЫ ИНОГДА МЕНЯЮТ СВОИ ФОРМЫ?",
                scores: { "ДА": 10, "НЕТ": 0, "НЕ ЗНАЮ": 8 }
            },
            { // Q20: Loss of control, direct
                question: "ВЫ ЧУВСТВУЕТЕ, ЧТО ТЕРЯЕТЕ КОНТРОЛЬ НАД СИТУАЦИЕЙ?",
                scores: { "ДА": 11, "НЕТ": 0, "НЕ ЗНАЮ": 9 }
            },
            { // Q21: Auditory escalation
                question: "ГОЛОСА В ВАШЕЙ ГОЛОВЕ СТАНОВЯТСЯ ВСЕ ГРОМЧЕ?",
                scores: { "ДА": 12, "НЕТ": 0, "НЕ ЗНАЮ": 10 }
            },
            { // Q22: Existential dread
                question: "ВЫ ОЩУЩАЕТЕ БЕСПРИЧИННЫЙ СТРАХ ИЛИ ТРЕВОГУ?",
                scores: { "ДА": 13, "НЕТ": 0, "НЕ ЗНАЮ": 11 }
            },
            { // Q23: Paranoia
                question: "ВЫ ДУМАЕТЕ, ЧТО ЗА ВАМИ НАБЛЮДАЮТ?",
                scores: { "ДА": 14, "НЕТ": 0, "НЕ ЗНАЮ": 12 }
            },
            { // Q24: Breaking the fourth wall
                question: "ВЫ ПОНИМАЕТЕ, ЧТО ЭТО ПРОСТО ОПРОС?",
                scores: { "ДА": 0, "НЕТ": 15, "НЕ ЗНАЮ": 13 }
            },
            { // Q25: Final question, very high stakes
                question: "ВЫ ГОТОВЫ ПРИНЯТЬ ТО, ЧТО ВЫ НЕ ОДНИ?",
                scores: { "ДА": 16, "НЕТ": 0, "НЕ ЗНАЮ": 14 }
            }
        ];

        let currentQuestionIndex = -1;
        let unsettlingScore = 0;
        let nextQuestionPause = 400; // Начальная короткая пауза для первого вопроса

        const questionElement = document.getElementById('question');
        const optionsElement = document.getElementById('options');
        const gameArea = document.querySelector('.game-area');
        const endScreen = document.getElementById('endScreen');
        const endMessageElement = document.getElementById('endMessage');
        const body = document.body;
        const container = document.querySelector('.container');

        // Максимальный возможный счет: Сумма максимальных баллов по всем 25 вопросам = 195
        // (1+1+2+1+2+3+4+5+6+7+8+9+10+11+12+13+14+15+16 = 153)
        // Обновленные значения для концовок
        const endings = {
            low: { // 0-50 очков
                message: `<p>ВАШ РАЗУМ ЧИСТ.</p><p>ВЫ СВОБОДНЫ.</p>`,
                color: '#00ff00',
                animation: 'none'
            },
            medium: { // 51-120 очков
                message: `<p>ВЫ ВИДЕЛИ ТЕНИ.</p><p>ОНИ ЗАПОМНИЛИ ВАС.</p><p>БУДЬТЕ ОСТОРОЖНЫ.</p>`,
                color: '#ffdd00',
                animation: 'flicker 0.8s infinite alternate'
            },
            high: { // 121-195 очков
                message: `<p>ГРАНИЦЫ СТЁРТЫ.</p><p>ВЫ ВНУТРИ. ОНИ ВНУТРИ.</p><p>ДОБРО ПОЖАЛОВАТЬ.</p>`,
                color: '#ff0000',
                animation: 'flicker 0.3s infinite alternate'
            }
        };

        // Added for the first interaction to start audio context
        function startAudioContext() {
            if (Tone.context.state !== 'running') {
                Tone.start();
                console.log('AudioContext started');
            }
        }

        function startGame() {
            startAudioContext(); // Ensure audio context is running on first interaction
            gameArea.style.display = 'block';
            endScreen.style.display = 'none';
            body.className = '';
            container.style.transform = 'scale(1)';
            unsettlingScore = 0;
            nextQuestionPause = 400;
            currentQuestionIndex = 0;
            showQuestion();
        }

        async function showQuestion() {
            if (currentQuestionIndex < questions.length) {
                const q = questions[currentQuestionIndex];
                optionsElement.innerHTML = ''; // Очищаем существующие кнопки

                // Анимируем появление текста вопроса
                await typeText(questionElement, q.question, 50); // 50 мс задержка между символами

                const buttonLabels = ["ДА", "НЕТ", "НЕ ЗНАЮ"];
                const buttons = [];

                buttonLabels.forEach((label, index) => {
                    const button = document.createElement('button');
                    button.innerText = label;
                    button.dataset.optionType = label;
                    button.onclick = () => selectOption(button);
                    
                    // Добавляем специфический класс для начальной трансформации на основе метки
                    if (label === "ДА") {
                        button.classList.add('initial-transform-da');
                    } else if (label === "НЕТ") {
                        button.classList.add('initial-transform-net');
                    } else { // НЕ ЗНАЮ
                        button.classList.add('initial-transform-neznao');
                    }

                    optionsElement.appendChild(button);
                    buttons.push(button);
                });

                // Запускаем анимацию после небольшой задержки
                buttons.forEach((button, index) => {
                    setTimeout(() => {
                        // Удаляем класс начальной трансформации и добавляем класс show-button
                        if (button.dataset.optionType === "ДА") {
                            button.classList.remove('initial-transform-da');
                        } else if (button.dataset.optionType === "НЕТ") {
                            button.classList.remove('initial-transform-net');
                        } else {
                            button.classList.remove('initial-transform-neznao');
                        }
                        button.classList.add('show-button');
                    }, 50 + index * 200); // Небольшая начальная задержка + поэтапное появление
                });

                updateStage();
            } else {
                endGame();
            }
        }

        function selectOption(button) {
            const optionType = button.dataset.optionType;
            let scoreToAdd = questions[currentQuestionIndex].scores[optionType];
            
            unsettlingScore += scoreToAdd;

            // Устанавливаем паузу для следующего вопроса в зависимости от выбранного ответа
            if (scoreToAdd === 0) {
                nextQuestionPause = 400; // Быстрая, "нормальная" реакция
            } else if (scoreToAdd <= 2) { // Небольшая тревожность
                nextQuestionPause = 1000;
            } else if (scoreToAdd <= 4) { // Заметная тревожность
                nextQuestionPause = 1800;
            } else if (scoreToAdd <= 6) { // Сильная тревожность
                nextQuestionPause = 2800;
            } else if (scoreToAdd <= 9) { // Очень сильная тревожность
                nextQuestionPause = 4000;
            } else { // scoreToAdd > 9 (предельная тревожность)
                nextQuestionPause = 5000; // Максимальная, очень долгая пауза
            }

            // Инициируем скрытие текущих кнопок
            Array.from(optionsElement.children).forEach(btn => {
                btn.classList.remove('show-button'); // Удаляем класс, чтобы запустить обратную анимацию
                // Убеждаемся, что кнопки полностью скрыты после выбора (если CSS transition не успевает)
                btn.style.opacity = '0';
                btn.style.visibility = 'hidden'; // Ensure they are hidden
            });

            // Задержка перед показом следующего вопроса и очисткой контейнера
            setTimeout(() => {
                // Очищаем контейнер только после того, как кнопки скрылись
                optionsElement.innerHTML = '';
                currentQuestionIndex++;
                showQuestion();
            }, nextQuestionPause); // Используем рассчитанную паузу
        }

        function updateStage() {
            const totalStages = questions.length;
            // Сопоставляем текущий индекс вопроса стадиям. У нас 4 визуальные стадии.
            // Убедимся, что стадия находится в диапазоне от 1 до 4.
            const stage = Math.min(Math.floor((currentQuestionIndex / totalStages) * 4) + 1, 4);
            body.className = `stage-${stage}`;
            
            const scaleFactor = 1 + (currentQuestionIndex / questions.length) * 0.03; 
            container.style.transform = `scale(${scaleFactor})`;
        }

        function endGame() {
            gameArea.style.display = 'none';
            endScreen.style.display = 'block';
            body.classList.add('stage-final');
            container.style.transform = 'scale(1.03)';

            let finalEnding;
            // Максимальный счет 95
            if (unsettlingScore <= 50) { // Обновленные диапазоны
                finalEnding = endings.low;
            } else if (unsettlingScore <= 120) { // Обновленные диапазоны
                finalEnding = endings.medium;
            } else { // 121-195 очков
                finalEnding = endings.high;
            }

            endMessageElement.innerHTML = finalEnding.message;
            endMessageElement.style.color = finalEnding.color;
            endMessageElement.style.animation = finalEnding.animation;
            endMessageElement.style.textShadow = `0 0 15px ${finalEnding.color}B3`;
        }

        // Инициализация - показываем стартовую кнопку
        document.addEventListener('DOMContentLoaded', () => {
            gameArea.style.display = 'block';
            endScreen.style.display = 'none';
            questionElement.innerText = "НАЧАТЬ ОПРОС?";
            
            // Создаем и отображаем кнопку "НАЧАТЬ"
            const startButton = document.createElement('button');
            startButton.innerText = "НАЧАТЬ";
            startButton.onclick = startGame;
            // Добавляем специальный класс для начальной кнопки, чтобы она была сразу видна
            startButton.classList.add('start-button'); 
            optionsElement.appendChild(startButton);

            body.classList.add('stage-1'); // Устанавливаем начальную стадию
        });
    </script>
</body>
</html>
